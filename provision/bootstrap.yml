---
# Bootstrap a AWS ec2 controller for AIP related playbooks.
#
# It creates all common resource for other playbooks:
# - The subnet security groups
# - The public key 
#
#
- hosts: localhost:&bootstrap
  connection: local
  tasks:
    - name: Create insubnet sec group
      ec2_group:
        name: aip_default 
        description: Allow in group and ssh communication
        rules:
          - proto: all
            group_name: aip_default
          - proto: tcp
            ports:
              - 22
            cidr_ip: 0.0.0.0/0

    - name: Create sec group for WinRM and RDP
      ec2_group:
          name: winsec
          description: WinRM RDP security group
          rules:
              - proto: tcp
                ports:
                    - 3389
                cidr_ip: 0.0.0.0/0
                rule_desc: RDP
              - proto: tcp
                ports:
                    - 5986
                cidr_ip: 0.0.0.0/0
                rule_desc: WinRM-HTTPS

    - name: Create key pair
      ec2_key:
        name: aip_controller_key
        key_material: "{{ lookup('file', '{{ public_key }}') }}"

    - name: Bootstrap AWS controller
      ec2:
        # role of the instance
        instance_profile_name: "{{instance_profile_name}}"
        key_name: aip_controller_key
        instance_type: t2.nano
        vpc_subnet_id: '{{vpc_subnet_id}}'
        image: '{{ debian_ami_id }}'
        wait: true
        groups:
          - aip_default
        private_ip: '{{aip_aws_controller_ip}}'
        instance_tags:
          Stage: expand
          Name: aip_aws_controller
          Groups: aip_aws_controller_hosts
          Base: aws_linux
      when: "aip_aws_controller_ip not in (hostvars.values()|map(attribute='private_ip_address')|list|string)"

- hosts: aip_aws_controller_hosts:&aws_linux
  name: AIP Aws controller node
  gather_facts: no

  vars:
    aipond_dir: "/home/admin"
    home: "{{ lookup('env', 'HOME') }}"

  tasks:
    - name: Wait for SSH to come up
      wait_for_connection:
        timeout: 320

    - name: Gather facts for the first time
      setup:

    - name: Install pip
      become: yes
      apt:
        name: python-pip

    - name: Install git
      become: yes
      apt:
        name: git

    - name: Install rsync
      become: yes
      apt:
        name: rsync

    - name: Copy ansible files
      block:
      - name: Sync ansible files
        become: yes
        synchronize:
          src: ../../
          dest: "{{aipond_dir}}"

      - name: Copy dot files
        copy:
          src: "{{ home }}/.aip-aws"
          dest: "~/.aip-aws"

      - name: Copy aws region dot file
        copy:
          src: "{{ home }}/.aws-region"
          dest: "~/.aws-region"
        
      tags:
        - sync
        
    - name: Install pip libraries
      become: yes
      pip:
        name:
          - requests==2.21.0
          - ansible
          - pywinrm
          - botocore
          - boto3

    - name: Install ansible-requirements
      become: yes
      shell: "ansible-galaxy install --role-file={{aipond_dir}}/provision/requirements.yml --roles-path=/etc/ansible/roles"

    - name: Tag stage as init
      delegate_to: localhost
      vars:
        ansible_connection: local
      ec2_tag:
        resource: "{{instance_id}}"
        tags:
          Stage: init


